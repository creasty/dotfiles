- set_fact:
    lua: {}

- name: install dependency
  homebrew:
    name:  '{{ item }}'
    state: present
  with_items:
    - ruby-build
    - openssl
    - readline

- name: check luaenv
  command: |
    bash -lc 'which luaenv'
  register: which_luaenv
  ignore_errors: yes

- name: install luaenv
  command: |
    bash -lc 'anyenv install luaenv'
  when: which_luaenv.rc > 0

- name: install plugins
  git:
    repo: 'https://github.com/{{ item }}.git'
    dest: '{{ lua.plugins_dir }}/{{ item }}'
  with_items: '{{ lua.plugins }}'
  when: lua.plugins_dir and lua.plugins

- name: get installed versions
  command: |
    bash -lc 'luaenv versions'
  register: installed_versions

- name: install lua
  command: |
    bash -lc 'luaenv install {{ item | quote }}'
  when: |
    lua.versions and installed_versions.stdout.find(item) == -1
  with_items: '{{ lua.versions }}'

- name: set global lua
  command: |
    bash -lc 'luaenv global {{ lua.versions[0] | quote }}'
  when: lua.versions

- name: get installed packages
  command: |
    bash -lc 'luarocks list'
  register: installed_packages

- name: install packages
  command: |
     bash -lc 'luarocks install {{ item | quote }}'
  when: |
    lua.packages and installed_packages.stdout.find(item) == -1
  with_items: '{{ lua.packages }}'
