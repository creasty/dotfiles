#!/usr/bin/env bash

CMD=kube
REPO=github.com/wantedly/kube

ARGS=()
for a in "$@"; do
  ARGS=(${ARGS[@]} "$a")
done

export BUNDLE_GEMFILE="$(ghq root)/$REPO/Gemfile"
CMD=(envchain wtd bundle exec "$CMD")

case "${ARGS[0]}" in
  xlogs)
    if [ -n "${ARGS[1]}" ]; then
      ${CMD[@]} get po -l role="${ARGS[1]}" --output=name 2>/dev/null \
        | sed -e 's#pod/##g' \
        | tr -d "\r" \
        | parallel -a - ${CMD[@]} logs '\\-f'

      exit $?
    fi
    ;;

  oneoff)
    ${CMD[@]} run -i --tty --rm ubuntu --image=ubuntu --restart=Never -- bash
    exit $?
    ;;
esac

${CMD[@]} ${ARGS[@]}
