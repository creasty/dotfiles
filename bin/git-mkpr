#!/usr/bin/env bash

source "$(dirname $0)/../lib/helpers.sh"

HEAD="$(git symbolic-ref --short HEAD)"

if [ $# -eq 2 ]; then
  BASE="$1"
  TITLE="$2"
else
  BASE='master'
  TITLE="$1"
fi


section 'Prepare branch for a request'

LAST_COMMIT="$(git log -n 1 --pretty=format:'%s' "${BASE}..${HEAD}" | cat)"

if [ -z "$LAST_COMMIT" ]; then
  if [ -z "$TITLE" ]; then
    print_error 'Empty title'
    exit 1
  fi

  subsection 'Create empty commit'
  git commit --allow-empty -m "$TITLE" || exit 1
  print_status $?
else
  TITLE="${TITLE:-$LAST_COMMIT}"
fi

subsection 'Push'
git auto-ref push


section "Request '$TITLE' to $BASE from $HEAD"

URL="$(git github mk-pr "$BASE" "$HEAD" "$TITLE" | tr -d "\n")"

if [ -z "$URL" ]; then
  print_error "Couldn't create pull request"
  exit 1
fi

print_success "$URL"

echo -n "$URL" | pbcopy
