#!/usr/bin/env bash

source "$(dirname $0)/../lib/helpers.sh"

migrate_databases() {
  local databases="$(cat)"
  local count="$(echo "$databases" | wc -l | tr -d ' ')"

  print_info "$count databases found:"
  echo "$databases" | sed 's/^/  - /'
  echo

  local migration_cmd

  if [ "$1" = '-t' ]; then
    migration_cmd="test:prepare"
  else
    migration_cmd="migrate"
  fi

  echo "$databases" | {
    while read -r database; do
      cmd="bundle exec rake $database:$migration_cmd"

      section "$cmd"
      $cmd
    done
  }
}

main() {
  find ./config -name '*database.yml' \
    | xargs -n1 -I{} basename {} '.yml' \
    | sed -e 's/^database$/db/' -e 's/_database$/_db/' \
    | migrate_databases $1
}

main $1
