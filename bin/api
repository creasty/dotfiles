#!/usr/bin/env bash

set -eu
set -o pipefail


#  Utils
#-----------------------------------------------
do_help() {
  cat <<HELP
api <options> [get|post|put|patch|delete] \$path

OPTIONS:
  -p          Use a \`production\` server (default is \`development\`)
  -s          Request with system's credentials (basic auth)
  -u{name}    Request with user's credentials (access token)
              {name} -- select other variation of access tokens
  -v          Debug
  -h          Show help

COMMANDS:
  api help    Show help

GIT CONFIG:
  api.{env}.url
  api.{env}.access-token
  api.{env}.access-token-{name}
  api.{env}.basic-auth-cred
HELP
  exit 0
}

warn() {
  printf "\e[0;31m[WARN]\e[0m $@\n" 1>&2
}


#  Parse args
#-----------------------------------------------
METHOD=''
REQ_PATH=''
OPTIONS=('-s')
ARGS=('')

TOKEN_ID='access-token'
API_ENV='development'
AUTH_MODE='none'
DEBUG_FLAG=0

for a in "$@"; do
  if [ -n "$REQ_PATH" ]; then
    ARGS=(${ARGS[@]} "$a")
    continue
  fi

  case "$a" in
    help|-h)
      do_help
      ;;
    -p)
      API_ENV='production'
      ;;
    -u*)
      AUTH_MODE='user'
      if [ ${#a} -gt 2 ]; then
        TOKEN_ID="${TOKEN_ID}-${a:2}"
      fi
      ;;
    -s)
      AUTH_MODE='system'
      ;;
    -v)
      DEBUG_FLAG=1
      ;;
    -*)
      echo "Unknown option: $a" 1>&2
      exit 1
      ;;
    get|post|put|patch|delete)
      METHOD="$(tr '[a-z]' '[A-Z]' <<< "$a")"
      ;;
    *)
      REQ_PATH="$a"
      ;;
  esac
done


#  Auth
#-----------------------------------------------
NAMESPACE="api.${API_ENV}"

URL="$(git config "${NAMESPACE}.url" 2> /dev/null || true)"
if [ -z "$URL" ]; then
  warn "(no value)  git config --set ${NAMESPACE}.url"
  exit 1
fi

case "$AUTH_MODE" in
  user)
    ACCESS_TOKEN="$(git config "${NAMESPACE}.${TOKEN_ID}" 2> /dev/null || true)"
    if [ -n "$ACCESS_TOKEN" ]; then
      OPTIONS=(${OPTIONS[@]}
        -H "Authorization: Token token=$ACCESS_TOKEN"
      )
    else
      warn "(no value)  git config --set ${NAMESPACE}.${TOKEN_ID}"
    fi
    ;;

  system)
    BASIC_AUTH_CRED="$(git config "${NAMESPACE}.basic-auth-cred" 2> /dev/null || true)"
    if [ -n "$BASIC_AUTH_CRED" ]; then
      OPTIONS=(${OPTIONS[@]}
        -u "$BASIC_AUTH_CRED"
      )
    else
      warn "(no value)  git config --set ${NAMESPACE}.basic-auth-cred"
    fi
    ;;
esac


#  Regulate
#-----------------------------------------------
METHOD=${METHOD:=GET}
[ "${REQ_PATH:1:1}" != "/" ] && REQ_PATH="/$REQ_PATH"
[ "${URL: -1}" == "/" ] && URL="${URL:0:-1}"


#  Exec
#-----------------------------------------------
if [ "$DEBUG_FLAG" -eq 1 ]; then
  echo "URL:        $URL"
  echo "REQ_PATH:   $REQ_PATH"
  echo "METHOD:     $METHOD"
  echo "OPTIONS:    ${OPTIONS[@]}"
  echo "ARGS:       ${ARGS[@]}"
  echo "API_ENV:    $API_ENV"
  echo "AUTH_MODE:  $AUTH_MODE"
else
  [ -z "$REQ_PATH" ] && exit 1  # Validate

  curl \
    "${OPTIONS[@]}" \
    -H 'Content-Type: application/json' \
    -X "$METHOD" \
    "$URL$REQ_PATH" \
    ${ARGS[@]}
fi
