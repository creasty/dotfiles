#!/usr/bin/env bash

set -eu
set -o pipefail

xlogs() {
  [ -z "$1" ] && return

  kube get po -l role="$1" 2>/dev/null \
    | tail -n +2 \
    | awk '{ print $1 }' \
    | parallel --delay 5 -a - -j 1000% -u kube logs '\\-f'
}

oneoff() {
  local image="${2:-koudaiii/curl}"
  local run_cmd="${3:-bash}"
  local name="creasty-oneoff-$RANDOM"

  kube run -i --tty --rm "$name" --image="$image" --restart=Never -- "$run_cmd"
}

new-repo() {
  local repo="$1"
  local visibility="$2"
  kube qucli create "$repo" --visibility="$visibility"
  kube qucli add-team "$repo" infrastructure --role=admin
  kube qucli add-team "$repo" developer --role=write
  kube qucli add-user "$repo" wantedly+wantedlybot --role=write
  kube qucli get "$repo"
}

case "$1" in
  xlogs)    xlogs "${@:2}" ;;
  oneoff)   oneoff "${@:2}" ;;
  new-repo) new-repo "${@:2}" ;;

  *) kube "$@" ;;
esac
