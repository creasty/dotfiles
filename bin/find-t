#!/usr/bin/env bundle exec rails r

require 'pathname'


puts 'Scanning...'

name = ARGV[0]

exit if !name || '' == name

scopes     = name.split '.'
scope_size = scopes.size - 1


I18n.load_path.reverse.each do |file|
  founds        = []
  current_level = 0

  File.open(file) do |f|
    f.each_line.with_index do |line, n|
      next unless line =~ /\A([ ]*)(["']|)(\w+)\2:\s*(.*)\s*\z/

      indent, scope, text = $1, $3, $4
      level = indent.size >> 1

      if level == current_level || level + 1 == current_level
        if scope == scopes[current_level]
          if current_level == scope_size
            path = Pathname.new(file).relative_path_from(Rails.root).to_s
            founds.push [path, n + 1, line]
          end

          current_level += 1 if '' == text
        end
      elsif '' == text
        current_level -= 1
      end
    end
  end

  if founds.any?
    founds.reverse.each.with_index do |found, i|
      if i == 1
        puts "\n"
        puts "Conflicts within a file"
        puts "======================="
      end

      path, n, line = found

      puts
      puts '- %s:%d' % [path, n]
      puts line
    end

    exit
  end
end

puts
puts "Can't find '%s'" % name
