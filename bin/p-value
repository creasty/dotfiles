#!/usr/bin/env bash
#> p-value Nb/Db Na/Da
#>
#>     N*: Numerator
#>     D*: Denominator
#>     *b: Before
#>     *a: After
#>
#> - A small p-value (< 0.05) indicates strong evidence against the null hypothesis, so you reject the null hypothesis.
#> - A large p-value (> 0.05) indicates weak evidence against the null hypothesis, so you fail to reject the null hypothesis.
#> - p-values very close to the cutoff (0.05) are considered to be marginal (could go either way).

set -eu
set -o pipefail

SHARED_PATH="$HOME/docker/r-base"
TMP_SCRIPT_FILE='p-value.r'

INPUT_PATTERN='([0-9]+)\/([0-9]+)[ ]+([0-9]+)\/([0-9]+)'
R_TEMPLATE='prop.test(c(\3, \1), c(\4, \2))'

do_help() {
  cat "$0" | sed -n -E '/^#>/s/^#>[ ]?//p'
  exit 1
}

echo "$@" \
  | {
    grep -o -m 1 -E "$INPUT_PATTERN" || do_help
  } \
  | sed -E "s/$INPUT_PATTERN/$R_TEMPLATE/" \
  | tee "$SHARED_PATH/$TMP_SCRIPT_FILE"

r-base Rscript "/shared/$TMP_SCRIPT_FILE" \
  | sed -E $'s/(p-value [<=] [0-9e.-]+)/\e[0;32m\\1\e[0m/' \
  | sed -E $'/percent confidence interval/{n;s/(.+)/\e[0;32m\\1\e[0m/;}'
