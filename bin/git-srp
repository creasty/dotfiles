#!/usr/bin/env bash

set -eu
set -o pipefail

# @see http://gihyo.jp/dev/serial/01/perl-hackers-hub/000803
#
# SRP = R + U + ((L / 100) - 5)
#     where:
#       R: Unique revisions
#       U: Unique users
#       L: Lines of module
#
get_srp() {
  local target=$1

  local blame="$(git --no-pager blame --line-porcelain $target)"
  local r="$(
    echo "$blame" \
      | sed -n 's/^summary //p' \
      | sort \
      | uniq -c \
      | sort -nr \
      | wc -l
  )"
  local u="$(
    echo "$blame" \
      | sed -n 's/^author //p' \
      | sort \
      | uniq -c \
      | sort -nr \
      | wc -l
  )"
  local l="$(cat $target | wc -l)"

  echo $(($r + $u + ($l / 100 - 5))) $target
}

get_files() {
  git ls-files app lib config vendor script \
    | grep -E '\.rb$'
}

main() {
  for file in `get_files`; do
    get_srp $file
  done | sort -k1,1 -nr | head -n 30
}

main
